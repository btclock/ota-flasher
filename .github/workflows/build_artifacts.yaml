name: Build artifacts

on:
  workflow_dispatch:
    inputs:
      directory:
        description: 'Directory to run Docker command in'
        required: true
        default: '.'

jobs:
  build-windows:
    runs-on:
      - ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-
    - name: Cache pip packages
      id: pip-cache
      uses: actions/cache@v4
      with:
        path: /tmp/.cachepip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Run Docker Container
      run: |
        docker run --rm \
          --volume "/tmp/.cachepip:/wine/drive_c/users/root/appdata/local/pip/cache" \ 
          --volume "${{ github.workspace }}:/src/" \
          batonogov/pyinstaller-windows:latest
    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-artifacts
        path: dist/
